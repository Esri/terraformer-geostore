!function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(["terraformer/terraformer"],b),"object"==typeof a.navigator&&("undefined"==typeof a.Terraformer&&(a.Terraformer={}),a.Terraformer.GeoStore=b().GeoStore)}(this,function(){function a(){this._steps=[],this._arguments=[],this._current=0,this._error=null}function b(){this._events={},this._once={},this._maxListeners=10,this._add=function(a,b,c){var d={listener:b};return c&&(d.once=!0),this._events[a]?this._events[a].push(d):this._events[a]=[d],this._maxListeners&&this._events[a].count>this._maxListeners&&console&&console.warn&&console.warn("EventEmitter Error: Maximum number of listeners"),this},this.on=function(a,b){return this._add(a,b)},this.addListener=this.on,this.once=function(a,b){return this._add(a,b,!0)},this.removeListener=function(a){if(!this._events[a])return this;for(var b=this._events.length-1;b--;)this._events[b].listener===callback&&this._events.splice(b,1);return this},this.removeAllListeners=function(a){return this._events[a]=void 0,this},this.setMaxListeners=function(a){return this._maxListeners=a,this},this.emit=function(){var a,b=Array.prototype.slice.apply(arguments),c=[];if(b.length){var d=b.shift();if(this._events[d])for(a=this._events[d].length;a--;)this._events[d][a].listener.apply(null,b),this._events[d][a].once&&c.push(listener);for(a=c.length;a--;)this.removeListener(d,c[a])}return this}}function c(){var a=this;b.call(this),this._destination=[],this._emit=this.emit,this.emit=function(b,c){var d;if("data"===b)for(d=a._destination.length;d--;)a._destination[d].write(c);else if("end"===b)for(d=a._destination.length;d--;)a._destination[d].write(c);a._emit(b,c)}}function d(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return b.apply(a,c||arguments)}}function e(a){if(!a.store||!a.index)throw new Error("Terraformer.GeoStore requires an instace of a Terraformer.Store and a instance of Terraformer.RTree");this.index=a.index,this.store=a.store,this._stream=null,this._additional_indexes=[]}function f(a,b,c,d){for(var e=Object.keys(b),f=0,g=0;g<e.length;g++){if("function"!=typeof a[e[g]])return d("Index does not have a method matching "+e[g]),void 0;a[e[g]](b[g],function(a,b){if(f++,a)return d(a),f=e.length,void 0;for(var g=Object.keys(c),h=0;h<g.length;h++)b[g[h]]||delete c[g[h]];f===e.length&&d(null,c)})}}a.prototype.next=function(){var a=Array.prototype.slice.call(arguments);return this._steps.push(a.shift()),this._arguments[this._steps.length-1]=a,this},a.prototype.error=function(a){return this._error=a,this},a.prototype.done=function(a){this._current++;var b=Array.prototype.slice.call(arguments);if(a)this._error&&this._error.apply(this,b);else if(this._steps.length){var c=this._steps.shift();this._arguments[this._current],c.apply(this,this._arguments[this._current])}else this._callback&&this._callback()},a.prototype.start=function(a){this._callback=a;var b=this._steps.shift();if(b){var c=this._arguments[0];b.apply(this,c)}else this._callback&&this._callback()},c.prototype.pipe=function(a){this._destination.push(a)},c.prototype.unpipe=function(a){if(a)for(var b=this._destination.length-1;b--;)this._destination[b].listener===a&&this._destination.splice(b,1);else this._destination=[]};var g,h={};return"object"==typeof this.navigator&&(g=this.Terraformer),"object"==typeof module&&"object"==typeof module.exports&&(g=require("terraformer")),arguments[0]&&"function"==typeof define&&define.amd&&(g=arguments[0]),e.prototype.add=function(a,b){var c;if(!a.type.match(/Feature/))throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if("Feature"===a.type&&!a.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");if("FeatureCollection"===a.type){for(var d=0;d<a.features.length;d++){var e=a.features[d];if(c=g.Tools.calculateBounds(e),!e.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.index.insert({x:c[0],y:c[1],w:Math.abs(c[0]-c[2]),h:Math.abs(c[1]-c[3])},e.id)}this.store.add(a,b)}else c=g.Tools.calculateBounds(a),this.index.insert({x:c[0],y:c[1],w:Math.abs(c[0]-c[2]),h:Math.abs(c[1]-c[3])},a.id),this.store.add(a,b)},e.prototype.remove=function(a,b){this.get(a,d(this,function(c,e){c?b("Could not get feature to remove",null):this.index.remove(e,a,d(this,function(c){c?b("Could not remove from index",null):this.store.remove(a,b)}))}))},e.prototype.contains=function(b){var c=Array.prototype.slice.call(arguments);c.shift();var e=c.pop();if(c.length)var h=c[0];var i=new g.Primitive(b),j=g.Tools.calculateEnvelope(i);this.index.search(j,d(this,function(b,c){var d,j,k=[],l=0,m=0,n=this,o=new a;if(h&&n._additional_indexes.length){for(d={},j=0;j<c.length;j++)d[c[j]]=!0;for(var p=Object.keys(h),q=0;q<p.length;q++)for(j=0;j<n._additional_indexes.length;j++)if(n._additional_indexes[j].property===p[q]){var r=h[p[q]],s=n._additional_indexes[j].index;o.next(function(a,b,c){var d=this;f(a,b,c,function(a,b){c=b,d.done(a)})},s,r,d)}}o.start(function(){d&&(c=Object.keys(d));var a=function(a){if(l++,a){var b=new g.Primitive(a.geometry);i.within(b)&&(n._stream?l===c.length?n._stream.emit("end",a):n._stream.emit("data",a):k.push(a)),l>=c.length&&(m?e&&e("Could not get all geometries",null):n._stream?n._stream=null:e&&e(null,k))}},b=function(){l++,m++,l>=c.length&&e&&e("Could not get all geometries",null)};if(c&&c.length)for(var f=function(c,d){c?b():a(d)},h=0;h<c.length;h++)n.get(c[h],f);else e&&e(null,k)})}))},e.prototype.within=function(b){var c=Array.prototype.slice.call(arguments);c.shift();var e=c.pop();if(c.length)var h=c[0];var i=new g.Primitive(b),j=g.Tools.calculateEnvelope(i);this.index.within(j,d(this,function(b,c){var d,j,k=[],l=0,m=0,n=this,o=new a;if(h&&n._additional_indexes.length){for(d={},j=0;j<c.length;j++)d[c[j]]=!0;for(var p=Object.keys(h),q=0;q<p.length;q++)for(j=0;j<n._additional_indexes.length;j++)if(n._additional_indexes[j].property===p[q]){var r=h[p[q]],s=n._additional_indexes[j].index;o.next(function(a,b,c){var d=this;f(a,b,c,function(a,b){c=b,d.done(a)})},s,r,d)}}o.start(function(){d&&(c=Object.keys(d));var a=function(a){if(l++,a){var b=new g.Primitive(a.geometry);b.within(i)&&(n._stream?l===c.length?n._stream.emit("end",a):n._stream.emit("data",a):k.push(a)),l>=c.length&&(m?e&&e("Could not get all geometries",null):n._stream?n._stream=null:e&&e(null,k))}},b=function(){l++,m++,l>=c.length&&e&&e("Could not get all geometries",null)};if(c&&c.length)for(var f=function(c,d){c?b():a(d)},h=0;h<c.length;h++)n.get(c[h],f);else e&&e(null,k)})}))},e.prototype.update=function(a,b){var c=g.Primitive(a);if("Feature"!==c.type)throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!c.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.get(c.id,d(this,function(a,d){if(a)b("Could find feature",null);else{var e=new g.Primitive(d);this.index.remove(e.envelope(),e.id),this.index.insert(c.envelope(),c.id),this.store.update(c,b)}}))},e.prototype.get=function(a,b){this.store.get(a,b)},e.prototype.createReadStream=function(){return this._stream=new c,this._stream},e.prototype.addIndex=function(a){this._additional_indexes.push(a)},h.GeoStore=e,h});