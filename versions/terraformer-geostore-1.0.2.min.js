/*! Terraformer JS - 1.0.2 - 2013-12-04
*   https://github.com/esri/terraformer-geostore
*   Copyright (c) 2013 Esri, Inc.
*   Licensed MIT */!function(a,b){if("object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b(require("terraformer"))),"object"==typeof a.navigator){if(!a.Terraformer)throw new Error("Terraformer.GeoStore requires the core Terraformer library. http://github.com/esri/terraformer");a.Terraformer.GeoStore=b(a.Terraformer).GeoStore}}(this,function(a){function b(){this._steps=[],this._arguments=[],this._current=0,this._error=null}function c(){this._events={},this._once={},this._maxListeners=10,this._add=function(a,b,c){var d={listener:b};return c&&(d.once=!0),this._events[a]?this._events[a].push(d):this._events[a]=[d],this._maxListeners&&this._events[a].count>this._maxListeners&&console&&console.warn&&console.warn("EventEmitter Error: Maximum number of listeners"),this},this.on=function(a,b){return this._add(a,b)},this.addListener=this.on,this.once=function(a,b){return this._add(a,b,!0)},this.removeListener=function(a){if(!this._events[a])return this;for(var b=this._events.length-1;b--;)this._events[b].listener===callback&&this._events.splice(b,1);return this},this.removeAllListeners=function(a){return this._events[a]=void 0,this},this.setMaxListeners=function(a){return this._maxListeners=a,this},this.emit=function(){var a,b=Array.prototype.slice.apply(arguments),c=[];if(b.length){var d=b.shift();if(this._events[d])for(a=this._events[d].length;a--;)this._events[d][a].listener.apply(null,b),this._events[d][a].once&&c.push(listener);for(a=c.length;a--;)this.removeListener(d,c[a])}return this}}function d(){var a=this;c.call(this),this._destination=[],this._emit=this.emit,this.emit=function(b,c){var d;if("data"===b)for(d=a._destination.length;d--;)a._destination[d].write(c);else if("end"===b)for(d=a._destination.length;d--;)a._destination[d].write(c);a._emit(b,c)}}function e(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return b.apply(a,c||arguments)}}function f(a){if(!a.store||!a.index)throw new Error("Terraformer.GeoStore requires an instace of a Terraformer.Store and a instance of Terraformer.RTree");this.index=a.index,this.store=a.store,this._stream=null,this._additional_indexes=[]}function g(a,b,c){var d=a.property;b.properties&&void 0!==b.properties[d]&&null!==b.properties[d]&&a.index.add(b.properties[d],b.id,c)}function h(a,b,c){var d=a.property;b.properties&&void 0!==b.properties[d]&&null!==b.properties[d]&&a.index.remove(b.properties[d],b.id,c)}function i(a,b,c,d){for(var e=Object.keys(b),f=0,g=0;g<e.length;g++){if("function"!=typeof a[e[g]])return d("Index does not have a method matching "+e[g]),void 0;a[e[g]](b[g],function(a,b){if(f++,a)return d(a),f=e.length,void 0;for(var g=Object.keys(c),h=0;h<g.length;h++)b[g[h]]||delete c[g[h]];f===e.length&&d(null,c)})}}b.prototype.next=function(){var a=Array.prototype.slice.call(arguments);return this._steps.push(a.shift()),this._arguments[this._steps.length-1]=a,this},b.prototype.error=function(a){return this._error=a,this},b.prototype.done=function(a){function b(a,b){f.done(a,b)}this._current++;var c=Array.prototype.slice.call(arguments);if(a)this._error&&this._error.apply(this,c);else if(this._steps.length){var d=this._steps.shift(),e=this._arguments[this._current],f=this;e.push(b),d.apply(this,e)}else this._callback&&this._callback.apply()},b.prototype.start=function(a){function b(a,b){d.done(a,b)}this._callback=a;var c=this._steps.shift(),d=this;if(c){var e=this._arguments[0];e.push(b),c.apply(this,e)}else this._callback&&this._callback()},d.prototype.pipe=function(a){this._destination.push(a)},d.prototype.unpipe=function(a){if(a)for(var b=this._destination.length-1;b--;)this._destination[b].listener===a&&this._destination.splice(b,1);else this._destination=[]};var k={};return f.prototype.add=function(c,d){var e,f,h,i,j,k=this;if(!c.type.match(/Feature/))throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if("Feature"===c.type&&!c.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");if("FeatureCollection"===c.type){for(h=0;h<c.features.length;h++){if(j=c.features[h],e=a.Tools.calculateBounds(j),!j.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.index.insert({x:e[0],y:e[1],w:Math.abs(e[0]-e[2]),h:Math.abs(e[1]-e[3])},j.id)}if(this._additional_indexes&&this._additional_indexes.length){for(f=new b,h=0;h<c.features.length;h++)for(j=c.features[h],i=0;i<this._additional_indexes.length;i++)f.next(g,this._additional_indexes[i],j);f.next(function(a){k.store.add(a)},c),f.start(d)}else this.store.add(c,d)}else if(e=a.Tools.calculateBounds(c),this.index.insert({x:e[0],y:e[1],w:Math.abs(e[0]-e[2]),h:Math.abs(e[1]-e[3])},c.id),this._additional_indexes&&this._additional_indexes.length){for(f=new b,i=0;i<this._additional_indexes.length;i++)f.next(g,this._additional_indexes[i],c);var l=function(a,b){k.store.add(a,b)};f.next(l,c),f.start(d)}else this.store.add(c,d)},f.prototype.remove=function(a,c){var d=this;this.get(a,e(this,function(f,g){f?c("Could not get feature to remove",null):this.index.remove(g,a,e(this,function(e){if(e)c("Could not remove from index",null);else if(this._additional_indexes&&this._additional_indexes.length){for(sync=new b,j=0;j<this._additional_indexes.length;j++)sync.next(h,this._additional_indexes[j],g);var f=function(a,b){d.store.remove(a,b)};sync.next(f,g),sync.start(c)}else this.store.remove(a,c)}))}))},f.prototype.contains=function(c){var d=Array.prototype.slice.call(arguments);d.shift();var f=d.pop();if(d.length)var g=d[0];var h=new a.Primitive(c),j=a.Tools.calculateEnvelope(h);this.index.search(j,e(this,function(c,d){var e,j,k=[],l=0,m=0,n=this,o=new b;if(g&&n._additional_indexes.length){for(e={},j=0;j<d.length;j++)e[d[j]]=!0;for(var p=Object.keys(g),q=0;q<p.length;q++)for(j=0;j<n._additional_indexes.length;j++)if(n._additional_indexes[j].property===p[q]){var r=g[p[q]],s=n._additional_indexes[j].index;o.next(function(a,b,c,d){i(a,b,c,function(a,b){c=b,d(a)})},s,r,e)}}o.next(function(){e&&(d=Object.keys(e));var b=function(b){if(l++,b){var c=new a.Primitive(b.geometry);h.within(c)&&(n._stream?l===d.length?(n._stream.emit("data",b),n._stream.emit("end")):n._stream.emit("data",b):k.push(b)),l>=d.length&&(m?f&&f("Could not get all geometries",null):n._stream?n._stream=null:f&&f(null,k))}},c=function(){l++,m++,l>=d.length&&f&&f("Could not get all geometries",null)};if(d&&d.length)for(var g=function(a,d){a?c():b(d)},i=0;i<d.length;i++)n.get(d[i],g);else f&&f(null,k)}),o.start()}))},f.prototype.within=function(c){var d=Array.prototype.slice.call(arguments);d.shift();var f=d.pop();if(d.length)var g=d[0];var h=new a.Primitive(c),j=a.Tools.calculateEnvelope(h);this.index.within(j,e(this,function(c,d){var e,j,k=[],l=0,m=0,n=this,o=new b;if(g&&n._additional_indexes.length){for(e={},j=0;j<d.length;j++)e[d[j]]=!0;for(var p=Object.keys(g),q=0;q<p.length;q++)for(j=0;j<n._additional_indexes.length;j++)if(n._additional_indexes[j].property===p[q]){var r=g[p[q]],s=n._additional_indexes[j].index;o.next(function(a,b,c,d){i(a,b,c,function(a,b){c=b,d(a)})},s,r,e)}}o.next(function(){e&&(d=Object.keys(e));var b=function(b){if(l++,b){var c=new a.Primitive(b.geometry);c.within(h)&&(n._stream?l===d.length?(n._stream.emit("done",b),n._stream.emit("end")):n._stream.emit("data",b):k.push(b)),l>=d.length&&(m?f&&f("Could not get all geometries",null):n._stream?n._stream=null:f&&f(null,k))}};o.start();var c=function(){l++,m++,l>=d.length&&f&&f("Could not get all geometries",null)};if(d&&d.length)for(var g=function(a,d){a?c():b(d)},i=0;i<d.length;i++)n.get(d[i],g);else f&&f(null,k)})}))},f.prototype.update=function(b,c){var d=a.Primitive(b);if("Feature"!==d.type)throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!d.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.get(d.id,e(this,function(b,e){if(b)c("Could find feature",null);else{var f=new a.Primitive(e);this.index.remove(f.envelope(),f.id),this.index.insert(d.envelope(),d.id),this.store.update(d,c)}}))},f.prototype.get=function(a,b){this.store.get(a,b)},f.prototype.createReadStream=function(){return this._stream=new d,this._stream},f.prototype.addIndex=function(a){this._additional_indexes.push(a)},k.GeoStore=f,k});